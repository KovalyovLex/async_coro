name: Auto Approve After All Checks
on:
  check_suite:
    types: [completed]

jobs:
  approve-if-success:
    runs-on: ubuntu-latest
    steps:
      - name: Get PR for commit
        uses: actions/github-script@v7
        id: get-pr
        with:
          github-token: ${{ secrets.async_coro_approver_bot }}
          script: |
            const prs = await github.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.payload.check_suite.head_sha
            });
            if (prs.data.length === 0) {
              core.setFailed("No PR found for this commit");
              return;
            }
            core.setOutput("pr_number", prs.data[0].number);

      - name: Check combined status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.async_coro_approver_bot }}
          script: |
            const pr_number = "${{ steps.get-pr.outputs.pr_number }}";
            const pr = await github.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number
            });

            const combined = await github.repos.getCombinedStatusForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.data.head.sha
            });

            console.log("Combined state:", combined.data.state);
            if (combined.data.state === "success") {
              console.log("✅ All checks passed — approving PR");
              await github.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr_number,
                event: "APPROVE"
              });
            } else {
              console.log("⏳ Still waiting for checks to pass");
            }
